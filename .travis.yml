language: node_js
node_js:
- '8'

dist: trusty

addons:
  chrome: stable
  ssh_known_hosts:
  - service.trustcnct.net:19198
  - 46.252.27.45:19198

before_install:
- sudo chown root /opt/google/chrome/chrome-sandbox
- sudo chmod 4755 /opt/google/chrome/chrome-sandbox
- google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost:9876 &
- npm install -g @angular/cli

install: npm install

script:
- ng test --single-run --progress
- ng e2e

after_success:
- ng build -prod --base-href=/playground/
- git rev-parse HEAD > dist/version.txt

before_deploy:
- openssl aes-256-cbc -K $encrypted_fb365c1216b5_key -iv $encrypted_fb365c1216b5_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- ssh-add /tmp/deploy_rsa

deploy:
  provider: script
  skip_cleanup: true
  script: rsync -r --delete-after --quiet -e "ssh -p 19198" $TRAVIS_BUILD_DIR/dist/ travis@service.trustcnct.net:/var/www/playground/
  on:
    branch: travis-test

after_deploy:
- if [ `git rev-parse HEAD` != `curl https://service.trustcnct.net/playground/version.txt`] exit 1
